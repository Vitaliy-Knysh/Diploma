# Робот-курьер на базе Nvidia Jetbot #
![demo2](https://user-images.githubusercontent.com/75195148/188173051-c75fb4db-4126-403a-8b3f-602ac6475926.gif)

На этой странице моя дипломная работа. Проект полностью сделан на языке Python.

## Постановка задачи и реализованное ПО ##
Двухколёсный робот находится в среде с препятствиями. Робот должен доехать до груза(его роль выполняет синяя шайба), забрать его и приехать в точку назначения. Положение груза и точка назначения заранее известны. Над рабочим пространством робота есть ip-камера. 

Перечень решенных задач:
1. Определение положения робота, его угловой и линейной скорости при помощи ip-камеры и OpenCV.
2. Реализовано клиент-серверное приложение для управления роботом с обратной связью через ip-камеру. Реализовано на модуле socket и threading.
3. Опрелеление препятствий при помощи лазерного дальномера.
4. Планирование движения в среде с обнаруженными препятствиями. Программа строит граф и находит путь при помощи волнового алгоритма.

# А теперь поподробнее #

## Используемое оборудование ##
Проект сделан на базе мобильного робота Nvidia Jetbot. Робот выполнен по двухколёсной схеме, с двигателями без обратной связи. 

![image](https://user-images.githubusercontent.com/75195148/188177514-cca5588a-53f3-40e9-a5da-cae0e5658d35.png)

Робот находится на столе и не может выехать за его пределы:

![image](https://user-images.githubusercontent.com/75195148/188181506-cc34bcdf-c0de-47dc-89d5-59bc4a2f2245.png)
 
Чтобы превратить робота в курьера, понадобилось доработать его: установить лазерный дальномер, испровизированный ковш для перемещения грузов и метку для распознавания камерой:

 ![image](https://user-images.githubusercontent.com/75195148/188176758-a0d95ca8-63e1-4b7c-82a8-4cf2ed15de5a.png)

Из исходного ПО на роботе была только библиотека с двумя функциями для управления двигателями: подать на них определенную мощность и остановить.

## Почему на роботе картинка, похожая на QR-код? ## 
У двигателей робота нет обратной связи, а на борту нет инерциальных датчиков. Единственный способ отслеживать своё положение в пространстве - по данным, получаемым с дальномера. Способ этот медленный, ненадёжный и очень трудный. Мной был выбран другой вариант - следить за роботом при помощи ip-камеры, расположенной над рабочим пространством робота. 
Мной была создана квадратная метка, по которой можно однозначно определить ориентацию робота и его порядковый номер. 

![image](https://user-images.githubusercontent.com/75195148/188188745-fdbf8bbd-aca7-4708-8d68-7d36c3e560e6.png)

Вертикальная черта указывает направление "вперёд", а фигуры слева и справа от неё нужны для определения конкретного робота, если их несколько. 

## Распознавание метки ##
Распознавание метки происходит в несколько этапов при помощи OpenCV. Рассмотрим алгоритм на примере метки, повернутой на 60 градусов:

![image](https://user-images.githubusercontent.com/75195148/188197425-47061a8b-4ef2-4f16-ba1e-9d71a096f23f.png)

1. Найти на экране замкнутый четырехугольный контур с заданной площадью
 ![image](https://user-images.githubusercontent.com/75195148/188197484-14361080-7a8b-481f-9d1a-4b1545c4d7e1.png)

2. Обрезать изображение, чтобы на нем осталась только метка

 ![image](https://user-images.githubusercontent.com/75195148/188197649-62659170-ac53-4da4-bdd9-80b868c4471e.png)
 
3. По наклону верхней линии(выделена зелёным) определить угол наклона метки и развернуть метку на этот угол

 ![image](https://user-images.githubusercontent.com/75195148/188197784-05dc7c77-8fdc-4fc4-8667-91be91487c25.png)
 
4. Снова ообезать изображение, чтобы на экране осталась только метка

![image](https://user-images.githubusercontent.com/75195148/188197986-d2656c82-980b-46d8-a099-ad04676e11d5.png)

5. Определить главную линию метки

![image](https://user-images.githubusercontent.com/75195148/188209592-44abc54e-b638-4054-991e-ec92fbccdfd8.png)

6. Вычесть угол поворота метки(30°) из угла, на который повернута главная линия(90°)

В итоге мы получили исходные 60°.

Робот действует в координатах, заданных разрешением камеры, то есть цена деления - один пиксель. Достаточно точно перевести пиксели в реальные величины невозможно из-за искажения картинки типа "рыбий глаз". Это станет проблемой далее, на этапе работы с лазерным дальномером.

## Управление роботом через сокет ##

Изображение с камеры передается на стационарный компьютер(далее просто компьютер), так как вычислительные мощности робота очень ограничены. Поэтому управление роботом организовано так: камера передает картинку на компьютер, компьютер определяет положение робота и выдаёт роботу команду на движение. Двигается робот небольшими рывками вперед, влево или вправо. На фото - движение по треугольной траектории.

![image](https://user-images.githubusercontent.com/75195148/188445533-ac12ce4d-e7ff-4e17-839b-286ec00b9ef2.png)

Зеленым обозначен пройденный путь, голубым - траектория из трех точек, филоетовым - направление на следующую точку маршрута.

Для управления роботом нужно сделать компьютер сервером, а робота - клиентом. Так как программа распознавания метки привязана к кадровой частоте, сервер работает в отдельном потоке. Блок-схема работы клиента и сервера приведена ниже, после раздела о работе с лазерными дальномером.

## Планирование движения ##

Планирование движения реализовано при помощи графа. Программа генерирует граф на основе разрешение картинки, полученной с камеры.

![image](https://user-images.githubusercontent.com/75195148/188448475-36b91aa8-06af-42f8-afd5-62fa612ce5d2.png)

Вот так граф выглядит без привязки к изображению.


